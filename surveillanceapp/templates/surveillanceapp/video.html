{% extends 'surveillanceapp/base.html' %}
{% load static %}

{% block extraheadjs %}
    <script src="{% static 'js/highcharts.js' %}"></script>
{% endblock %}

{% block main-content %}
    <div class="row">
        <div class="col-lg-12">
            <button id="video-play-btn" class="btn btn-primary">Play Video</button>
            <a href="{% url 'surveillanceapp:stationlist' %}" id="report-btn" class="btn btn-success pull-right" style="display: none">View Report</a>
        </div>
    </div>
    <div class="row" style="padding-top: 2%">
        <div id="graph-body" class="col-lg-12">
            <div class="col-lg-6" id="number-graph">

            </div>
            <div class="col-lg-6" id="congestion-graph">

            </div>
        </div>
    </div>
    <div class="row" style="padding-top: 2%">
        <div id="bargraph" class="col-lg-10 col-lg-push-1">
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    <script>
        var playbtn = document.querySelector('#video-play-btn');
        var reportbtn = document.querySelector('#report-btn');
        var listbody = document.querySelector('#list-body');
        var socket = null;
        var numbergraph;
        var congestiongraph;
        var bargraph;
        var bargraphoptions;

        function cleargraph() {
            numbergraph = Highcharts.chart('number-graph', {
                credits:{
                    enabled: false
                },
                title: {
                    text: 'Total Number of Vehicles per second interval'
                },
                plotOptions: {
                    series: {
                        pointStart: 1
                    }
                },
                yAxis: {
                    title: {
                        text: 'Number of Vehicles'
                    }
                },
                xAxis: {
                    title: {
                        text: 'Time(seconds)'
                    }
                },
                series: [{
                    name: 'No.of vehicles',
                    color: '#296789',
                    data: []
                }]
            });

            congestiongraph = Highcharts.chart('congestion-graph', {
                credits:{
                    enabled: false
                },
                title: {
                    text: 'Approx Vehicle Congestion per second interval'
                },
                plotOptions: {
                    series: {
                        pointStart: 1
                    }
                },
                yAxis: {
                    title: {
                        text: 'Congestion Index'
                    }
                },
                xAxis: {
                    title: {
                        text: 'Time(seconds)'
                    }
                },
                series: [{
                    name: 'Congestion index',
                    color: '#7c212c',
                    data: []
                }]
            });

            bargraphoptions = {
                credits:{
                    enabled: false
                },
                chart: {
                    type: 'bar'
                },
                title: {
                    text: 'Real-time plot of no. of vehicles in the road by Vehicle Class'
                },
                xAxis: {
                    categories: ['Tempo', 'Bike', 'Car', 'Taxi', 'Micro', 'Pickup', 'Bus', 'Truck'],
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    min: 0,
                    max: 20,
                    title: {
                        text: 'No.of vehicles',
                        align: 'high'
                    },
                    labels: {
                        overflow: 'justify'
                    }
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: 'No.of vehicles',
                    color: '#1d6c0e',
                    data: []
                }]
            };

            bargraph = Highcharts.chart('bargraph', bargraphoptions);
        }

        function showbtn() {
            reportbtn.style.display = 'inline';
            stopbtn.style.display = 'none';
        }

        playbtn.addEventListener('click',function (event) {
            video_url = '{{ video.video_id }}';
            socket = new WebSocket('ws://'+window.location.host+'/video/'+video_url);
            socket.onopen = function open() {
                console.log('Websocket connection has opened successfully');
                socket.send(JSON.stringify({
                    'start': true,
                    'message': 'You can start the video'
                }));
                listbody.innerHTML = '';
                stopbtn.style.display = 'inline';
                reportbtn.style.display = 'none';
            };
            socket.onclose = function close(ev) {
                console.log('Websocket connection is now being closed');
                reportbtn.style.display = 'inline';
                stopbtn.style.display = 'none';
            };
            socket.onmessage = function message(event) {
                var received = JSON.parse(event.data);
                console.log(received);
                if(received['eof'] == true){
                    socket.close(1000,'Server closed it');
                    {#showbtn();#}
                }
                else {
                    var numbercount = received['numbercount'];
                    var congcount = received['congcount'];
                    var vclasscount = received['vclasscount'];
                    var shift = numbergraph.series[0].data.length > 20;
                    numbergraph.series[0].addPoint(numbercount, true, shift);
                    congestiongraph.series[0].addPoint(congcount, true, shift);
                    bargraphoptions.series[0].data = vclasscount;
                    bargraph.update(bargraphoptions,true);
                }
            };
            if(socket.readyState == WebSocket.OPEN){
                socket.onopen();
            }
            cleargraph();
            reportbtn.style.display = 'none';
        });

        stopbtn.addEventListener('click',function (ev) {
            socket.close(1000,'Stop button was pressed');
        });

    </script>
{% endblock %}